<script setup lang="ts">import { computed, onMounted, ref, h, shallowRef, reactive, inject } from 'vue'import { useI18n } from 'vue-i18n'import { useRouter } from 'vue-router'import { message, Modal } from 'ant-design-vue'import {  SearchOutlined,  CloseOutlined,  CheckOutlined,  FilterFilled,  LinkOutlined,  DeleteOutlined,  PlusOutlined,  EditOutlined,  MoreOutlined,} from '@ant-design/icons-vue'import { useProductStore } from '@/stores/productStore.ts'import { useFilters } from '@/composables/useFilters.ts'import type { FetchProductsParams, IProduct, TProductsResponse } from '@/types/product.ts'import type { MainLayoutContext } from '@/layouts/MainLayout.vue'import { useScreen } from '@/composables/useScreen.ts'import type { ColumnsType } from 'ant-design-vue/es/table'type Key = numberinterface Pagination {  current: number  pageSize: number}interface Filters {  [key: string]: string[]}interface Sorter {  field?: string  order?: 'ascend' | 'descend'}const layoutContext = inject<MainLayoutContext>('layoutContext')const { t } = useI18n()const { searchText, searchedColumn, handleSearch, handleReset } = useFilters()const router = useRouter()const productStore = useProductStore()const { isMobile, isTablet } = useScreen()const localResponse = shallowRef<TProductsResponse>()const localCategoryList = shallowRef<string[]>([])const searchInput = ref()const page = ref(1)const limit = ref(10)const changePrice = ref(false)const priceInputRef = ref<HTMLInputElement | null>(null)const loading = ref<boolean>(true)const state = reactive<{  selectedRowKeys: Key[]  loading: boolean}>({  selectedRowKeys: [],  loading: false,})const categoryFilters = computed(() =>  localCategoryList.value.map(item => ({    text: item,    value: item,  })))const columns = computed<ColumnsType>(() => {  const filters = categoryFilters.value  const mobile = isMobile.value  return [    {      title: t('product.id'),      dataIndex: 'id',      key: 'id',      width: 70,      sorter: true,      responsive: ['lg', 'md'],      align: 'center',    },    {      title: t('product.image'),      dataIndex: 'thumbnail',      key: 'thumbnail',      width: 90,      responsive: ['lg', 'md'],    },    {      title: t('product.name'),      dataIndex: 'title',      key: 'title',      customFilterDropdown: true,      filterMultiple: false,      onFilterDropdownOpenChange: (visible: boolean) => {        if (visible) {          setTimeout(() => {            searchInput.value.focus()          }, 100)        }      },      sorter: true,      width: mobile ? 110 : 'auto',    },    {      title: t('product.category'),      dataIndex: 'category',      key: 'category',      sorter: true,      width: mobile ? 80 : 180,      filters: filters,      filterMultiple: false,      onFilterDropdownOpenChange: async (visible: boolean) => {        if (visible && localCategoryList.value.length === 0) {          await productStore.fetchAllCategoryList()          localCategoryList.value = productStore.categories        }      },    },    {      title: t('product.price'),      dataIndex: 'price',      key: 'price',      sorter: true,      width: mobile ? 100 : 140,    },    {      title: t('product.stock'),      dataIndex: 'stock',      key: 'stock',      sorter: true,      width: 80,    },    {      title: mobile ? false : t('product.list.operations.title'),      key: 'operations',      width: mobile ? 22 : 140,      fixed: 'right',      align: 'right',    },  ]})const hasSelected = computed(() => state.selectedRowKeys.length > 0)const onSelectChange = (selectedRowKeys: Key[]) => {  state.selectedRowKeys = selectedRowKeys}const onTableChange = async (pagination: Pagination, filters: Filters, sorter: Sorter) => {  const { current, pageSize } = pagination  const { field, order } = sorter  limit.value = pageSize  page.value = current  await getProducts({    page: current,    limit: pageSize,    sortBy: field || 'id',    order: order === 'descend' ? 'desc' : 'asc',    search: filters['title']?.[0] ?? '',    category: filters['category']?.[0] ?? '',  })}const deleteProductHandler = async (id: number) => {  Modal.confirm({    title: t('product.list.delete.confirmTitle'),    content: t('product.list.delete.confirmContent'),    okText: t('product.list.delete.confirmOkText'),    centered: true,    okButtonProps: {      danger: true,    },    onOk: async () => {      state.loading = false      try {        const response = await productStore.deleteProduct(id)        if (response.success) {          state.selectedRowKeys = []          message.success(t('product.list.delete.success'))          await getProducts({            page: page.value,            limit: limit.value,            sortBy: 'id',            order: 'asc',          })        } else {          throw response        }      } catch (error: any) {        message.error(error.message)      } finally {        state.loading = false      }    },  })}const deleteBulkHandler = async () => {  Modal.confirm({    title: t('product.list.bulkDelete.confirmTitle'),    content: t('product.list.bulkDelete.confirmContent'),    okText: t('product.list.bulkDelete.confirmOkText'),    centered: true,    okButtonProps: {      danger: true,    },    onOk: async () => {      state.loading = false      try {        const response = await productStore.bulkDeleteProducts([...state.selectedRowKeys])        if (response.success) {          state.selectedRowKeys = []          message.success(t('product.list.bulkDelete.success'))          await getProducts({            page: page.value,            limit: limit.value,            sortBy: 'id',            order: 'asc',          })        } else {          throw response        }      } catch (error: any) {        message.error(error.message)      } finally {        state.loading = false      }    },  })}const editableData = ref<Record<number, IProduct>>({})const edit = (key: number) => {  editableData.value[key] = {    ...(localResponse.value?.products.filter(item => key === item.id)[0] as IProduct),  }}const cancel = (key: number) => {  delete editableData.value[key]}const save = (key: number) => {  const rawPrice = editableData.value[key]?.price  const formattedPrice = Number(Number(rawPrice).toFixed(2))  if (!formattedPrice) {    delete editableData.value[key]    return  }  productStore.updateProductPrice(key, formattedPrice)  delete editableData.value[key]}const bulkSave = (event: Event) => {  const input = event.target as HTMLInputElement  const formattedPrice = Number(Number(input?.value).toFixed(2))  if (!formattedPrice) {    changePrice.value = false    return  }  productStore.updateBulkProductPrice(state.selectedRowKeys, formattedPrice)  changePrice.value = false}const changePriceHandler = () => {  changePrice.value = true  setTimeout(() => {    if (priceInputRef.value) {      priceInputRef.value.focus()    }  }, 100)}const getProducts = async (props: FetchProductsParams) => {  loading.value = true  await productStore.fetchAll(props)  localResponse.value = productStore.productsResponse  loading.value = false}onMounted(() => {  getProducts({    page: 1,    limit: limit.value,    sortBy: 'id',    order: 'asc',  })  layoutContext?.setPageTitle('product.list.pageTitle')})</script><template v-memo="columns">  <a-card>    <div class="action_wrapper" v-if="hasSelected">      {{ t('product.list.selectedText', { count: state.selectedRowKeys.length }) }}      <a-button        v-if="state.selectedRowKeys.length > 1 && !changePrice"        type="primary"        @click="changePriceHandler"      >        {{ t('product.list.operations.changePriceSelected') }}      </a-button>      <div v-else-if="changePrice">        <a-input          @blur="changePrice = false"          ref="priceInputRef"          :placeholder="t('product.list.enterPrice')"          type="number"          step="0.01"          prefix="$"          @pressEnter="bulkSave"        />      </div>    </div>    <div class="table_wrapper">      <a-table        :size="isTablet ? 'middle' : isMobile ? 'small' : 'large'"        row-key="id"        :row-selection="{          selectedRowKeys: state.selectedRowKeys,          onChange: onSelectChange,          fixed: 'left',          columnWidth: isMobile ? 20 : 50,        }"        :pagination="{          total: localResponse?.total,          pageSize: limit,        }"        @change="onTableChange"        :data-source="localResponse?.products"        :columns="columns"        :loading="loading"        :scroll="{ x: 1140 }"        bordered      >        <template          #customFilterDropdown="{ setSelectedKeys, selectedKeys, confirm, clearFilters, column }"        >          <div style="padding: 8px">            <a-input              ref="searchInput"              :placeholder="`${t('product.list.search')} ${column.title}`"              :value="selectedKeys[0]"              style="width: 188px; margin-bottom: 8px; display: block"              @change="                (e: Event) =>                  setSelectedKeys(                    (e.target as HTMLInputElement).value                      ? [(e.target as HTMLInputElement).value]                      : []                  )              "              @pressEnter="handleSearch(selectedKeys, confirm, column.dataIndex)"            />            <a-button              type="primary"              size="small"              style="width: 90px; margin-right: 8px"              @click="handleSearch(selectedKeys, confirm, column.dataIndex)"            >              <template #icon><SearchOutlined /></template>              {{ t('product.list.search') }}            </a-button>            <a-button size="small" style="width: 90px" @click="handleReset(clearFilters)">              {{ t('product.list.reset') }}            </a-button>          </div>        </template>        <template #customFilterIcon="{ filtered, column }">          <search-outlined            v-if="column.key === 'title'"            :style="{ color: filtered ? '#108ee9' : undefined }"          />          <filter-filled v-else :style="{ color: filtered ? 'var(--primary-color)' : undefined }" />        </template>        <template #bodyCell="{ text, column, record }">          <template v-if="column.dataIndex === 'price'">            <div class="editable-cell">              <div v-if="editableData[record.id]" class="editable-cell-input-wrapper">                <a-input                  type="number"                  size="middle"                  v-model:value="editableData[record.id].price"                  prefix="$"                  @pressEnter="save(record.id)"                />                <a-space :size="4" direction="vertical">                  <check-outlined class="editable-cell-icon-check" @click="save(record.id)" />                  <close-outlined class="editable-cell-icon-cancel" @click="cancel(record.id)" />                </a-space>              </div>              <div v-else class="editable-cell-text-wrapper">                ${{ Number(text).toFixed(2) || ' ' }}                <edit-outlined class="editable-cell-icon" @click="edit(record.id)" />              </div>            </div>          </template>          <span v-if="searchText && searchedColumn === column.dataIndex">            <template              v-for="(fragment, i) in text                .toString()                .split(new RegExp(`(?<=${searchText})|(?=${searchText})`, 'i'))"            >              <mark                v-if="fragment.toLowerCase() === searchText.toLowerCase()"                :key="i"                class="highlight"              >                {{ fragment }}              </mark>              <template v-else>{{ fragment }}</template>            </template>          </span>          <template v-if="column.key === 'thumbnail'">            <a-avatar-group :max-count="1" shape="square">              <a-avatar v-for="image in record.images" :src="image" :key="record.id" />            </a-avatar-group>          </template>          <template v-if="column.key === 'operations'">            <a-dropdown v-if="isMobile">              <template #overlay>                <a-menu trigger-sub-menu-action="click">                  <a-menu-item key="1" @click="() => router.push(`/products/${record.id}`)">                    <LinkOutlined />                    {{ t('product.list.operations.seeDetails') }}                  </a-menu-item>                  <a-menu-item key="2" @click="() => router.push(`/products/update/${record.id}`)">                    <EditOutlined />                    {{ t('product.list.operations.update') }}                  </a-menu-item>                  <a-menu-item key="3" @click="() => deleteProductHandler(record.id)">                    <DeleteOutlined />                    {{ t('product.list.operations.delete') }}                  </a-menu-item>                </a-menu>              </template>              <a-button :icon="h(MoreOutlined)" />            </a-dropdown>            <a-space v-else>              <a-tooltip :title="t('product.list.operations.seeDetails')">                <a-button                  @click="() => router.push(`/products/${record.id}`)"                  :icon="h(LinkOutlined)"                  size="middle"                />              </a-tooltip>              <a-tooltip :title="t('product.list.operations.update')">                <a-button                  type="primary"                  @click="() => router.push(`/products/update/${record.id}`)"                  :icon="h(EditOutlined)"                  size="middle"                />              </a-tooltip>              <a-tooltip :title="t('product.list.operations.delete')">                <a-button                  danger                  @click="() => deleteProductHandler(record.id)"                  :icon="h(DeleteOutlined)"                  size="middle"                />              </a-tooltip>            </a-space>          </template>        </template>      </a-table>    </div>  </a-card>  <a-float-button-group shape="square" :style="{ right: '24px' }">    <a-float-button      v-if="state.selectedRowKeys.length > 1"      danger      @click="deleteBulkHandler"      :badge="{ count: state.selectedRowKeys.length }"      :tooltip="t('product.list.operations.deleteSelected')"    >      <template #icon>        <DeleteOutlined />      </template>    </a-float-button>    <a-float-button      :tooltip="t('product.list.operations.add')"      @click="() => router.push('/products/add')"    >      <template #icon>        <PlusOutlined />      </template>    </a-float-button>  </a-float-button-group></template><style scoped>.action_wrapper {  display: flex;  align-items: center;  justify-content: space-between;  margin-bottom: 16px;}.editable-cell {  position: relative;  .editable-cell-input-wrapper,  .editable-cell-text-wrapper {    padding-right: 24px;  }  .editable-cell-text-wrapper {    padding: 5px 24px 5px 5px;  }  .editable-cell-icon,  .editable-cell-icon-check,  .editable-cell-icon-cancel {    position: absolute;    right: 0;    width: 20px;    cursor: pointer;  }  .editable-cell-icon-check {    top: 0;  }  .editable-cell-icon-cancel {    bottom: 0;  }  .editable-cell-icon {    margin-top: 4px;    display: none;  }  .editable-cell-icon-check {    line-height: 28px;  }  .editable-cell-icon:hover,  .editable-cell-icon-check:hover {    color: #108ee9;  }}.editable-cell:hover .editable-cell-icon {  display: inline-block;}.table_wrapper {  width: 100%;  overflow-x: auto;}</style>